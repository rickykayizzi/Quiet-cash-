<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiet Cash</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (compat builds so we can use firebase.auth() style APIs) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    :root { --brand:#e50914; --bg:#f9f9f9; --text:#333; }
    *{box-sizing:border-box}
    body { margin:0; font-family:Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--brand); color:#fff; padding:15px; text-align:center; font-size:20px; font-weight:bold; }
    .content { padding:15px; display:none; animation:fade .3s ease; }
    .active { display:block; }
    @keyframes fade { from{opacity:0} to{opacity:1} }

    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; }
    .card { background:#fff; border-radius:15px; padding:20px; box-shadow:0 3px 8px rgba(0,0,0,.1); text-align:center; font-weight:bold; transition:.2s; }
    .card:active { transform:scale(.98); }

    .nav { position:fixed; bottom:0; left:0; right:0; display:flex; gap:4px; justify-content:space-around; background:#fff; border-top:1px solid #ddd; }
    .nav button { flex:1; padding:12px; border:none; background:none; font-size:14px; color:#555; }
    .nav .activeTab { color:var(--brand); font-weight:bold; }

    .panel { background:#fff; padding:20px; border-radius:15px; box-shadow:0 3px 8px rgba(0,0,0,.1); }
    label { display:block; margin-top:10px; font-size:14px; }
    input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:10px; }
    .btn { background:var(--brand); color:#fff; padding:12px; border:none; border-radius:10px; margin-top:15px; width:100%; font-size:16px; }
    .link { background:none; color:var(--brand); border:none; margin-top:10px; width:100%; text-align:center; }

    .balance-card { background:#fff; padding:20px; border-radius:15px; box-shadow:0 3px 8px rgba(0,0,0,.1); text-align:center; }
    .stars { font-size:24px; color:#ccc; }
    .stars .filled { color:gold; }

    ul { padding-left:18px; }
    li { margin:6px 0; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
<header>Quiet Cash</header>

<!-- Auth -->
<div id="auth" class="content active">
  <div class="panel">
    <h3 id="authTitle">Login</h3>
    <label>Email</label><input id="email" inputmode="email" autocomplete="email" />
    <label>Password</label><input id="pass" type="password" autocomplete="current-password" />
    <button class="btn" id="authActionBtn" onclick="doLogin()">Login</button>
    <button class="link" onclick="toggleAuth()">No account? Create one</button>
    <p class="muted">Your data is stored securely per account.</p>
  </div>
</div>

<!-- Home -->
<div id="home" class="content">
  <div class="grid">
    <div class="card" onclick="addTransaction('in')">Cash In</div>
    <div class="card" onclick="addTransaction('out')">Cash Out</div>
    <div class="card" onclick="showHistory()">History</div>
    <div class="card" onclick="switchTab('reports')">Reports</div>
    <div class="card" onclick="switchTab('balance')">Loss Check</div>
  </div>
  <div id="historyList" style="margin-top:20px;"></div>
</div>

<!-- Reports -->
<div id="reports" class="content">
  <div class="panel" style="margin-bottom:12px">
    <strong>Summary</strong>
    <div id="summary" class="muted"></div>
  </div>
  <canvas id="reportChart"></canvas>
</div>

<!-- Balance -->
<div id="balance" class="content">
  <div class="balance-card">
    <h2 id="balValue">Balance: UGX 0</h2>
    <h3 id="lossValue">Loss: UGX 0</h3>
    <div class="stars" id="ratingStars">★★★★★</div>
  </div>
</div>

<!-- Bottom Nav (hidden until logged in) -->
<div class="nav" id="bottomNav" style="display:none;">
  <button id="tabHome" class="activeTab" onclick="switchTab('home')">Home</button>
  <button id="tabReports" onclick="switchTab('reports')">Reports</button>
  <button id="tabBalance" onclick="switchTab('balance')">Balance</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  // ---- Firebase config (yours) ----
  const firebaseConfig = {
    apiKey: "AIzaSyCsrGLLl5_ihXNhpwpQC2iF4p2a7S0GULQ",
    authDomain: "quiet-cash.firebaseapp.com",
    projectId: "quiet-cash",
    storageBucket: "quiet-cash.firebasestorage.app",
    messagingSenderId: "976905194023",
    appId: "1:976905194023:web:35c67cbc71b37cc1609c02",
    measurementId: "G-L4MT65TZ1Z"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---- UI helpers ----
  function switchTab(tab){
    document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('activeTab'));
    const tabBtn = document.getElementById("tab"+tab.charAt(0).toUpperCase()+tab.slice(1));
    if(tabBtn) tabBtn.classList.add('activeTab');
    if(tab==="reports") renderChart();
    if(tab==="balance") updateBalance();
  }

  let signupMode = false;
  function toggleAuth(){
    signupMode = !signupMode;
    document.getElementById('authTitle').innerText = signupMode ? 'Create Account' : 'Login';
    document.getElementById('authActionBtn').innerText = signupMode ? 'Create Account' : 'Login';
  }

  function toast(msg){ alert(msg); }

  // ---- Auth actions ----
  function doLogin(){
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;
    if(!email || !pass) return toast("Enter email and password");
    auth.signInWithEmailAndPassword(email, pass).catch(e=>toast(e.message));
  }
  function doSignup(){
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;
    if(!email || !pass) return toast("Enter email and password");
    auth.createUserWithEmailAndPassword(email, pass)
      .then(()=>toast("Account created. You are now signed in."))
      .catch(e=>toast(e.message));
  }
  // Wire the same button to login or signup depending on mode
  document.getElementById('authActionBtn').onclick = ()=> signupMode ? doSignup() : doLogin();

  function logout(){ auth.signOut(); }

  // ---- App state ----
  let transactions = [];
  let chart;

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      document.getElementById('bottomNav').style.display = 'flex';
      switchTab('home');
      await loadTransactions();
    }else{
      document.getElementById('bottomNav').style.display = 'none';
      switchTab('auth');
    }
  });

  // ---- Data actions ----
  async function addTransaction(type){
    const amtStr = prompt("Enter amount:");
    if(!amtStr) return;
    const amount = +amtStr;
    if(isNaN(amount) || amount<=0) return toast("Enter a valid amount");
    const t = { type, amount, date: Date.now() };
    const uid = auth.currentUser.uid;
    await db.collection("users").doc(uid).collection("transactions").add(t);
    toast("Transaction saved!");
    await loadTransactions();
  }

  async function loadTransactions(){
    const uid = auth.currentUser.uid;
    const snap = await db.collection("users").doc(uid).collection("transactions")
                  .orderBy("date","desc").get();
    transactions = snap.docs.map(d=>d.data());
    showHistory();
    updateBalance();
    updateSummary();
  }

  function showHistory(){
    let html = "<h3>History</h3><ul>";
    transactions.forEach(t=>{
      const d = new Date(t.date).toLocaleString();
      html += `<li>${t.type==="in"?"➕":"➖"} ${t.amount} <span class="muted">(${d})</span></li>`;
    });
    html += "</ul>";
    document.getElementById("historyList").innerHTML = html;
  }

  function computeTotals(){
    const inflow = transactions.filter(t=>t.type==="in").reduce((a,b)=>a+b.amount,0);
    const outflow = transactions.filter(t=>t.type==="out").reduce((a,b)=>a+b.amount,0);
    return { inflow, outflow, net: inflow - outflow };
  }

  function updateSummary(){
    const { inflow, outflow, net } = computeTotals();
    document.getElementById('summary').innerText =
      `In: UGX ${inflow}  •  Out: UGX ${outflow}  •  Net: UGX ${net}`;
  }

  function renderChart(){
    const { inflow, outflow, net } = computeTotals();
    const ctx = document.getElementById("reportChart");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels:["Inflow","Outflow","Net Balance"],
        datasets:[{ data:[inflow,outflow,net], backgroundColor:["#4caf50","#f44336","#2196f3"] }]
      }
    });
  }

  function updateBalance(){
    const { inflow, outflow, net } = computeTotals();
    const loss = Math.max(0, outflow - inflow);
    document.getElementById("balValue").innerText = "Balance: UGX " + net;
    document.getElementById("lossValue").innerText = "Loss: UGX " + loss;

    const starsCount = Math.max(1, Math.min(5, 5 - Math.floor(loss / (Math.abs(net)+1) * 5)));
    let html = "";
    for(let i=1;i<=5;i++) html += `<span class="${i<=starsCount?"filled":""}">★</span>`;
    document.getElementById("ratingStars").innerHTML = html;
  }
</script>
</body>
</html>